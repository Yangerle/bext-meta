{"type":"javascript","name":"微信公众号音频下载","version":"1","tags":["工具脚本","音乐脚本"],"source":"/*\n * @name: 微信公众号音频下载\n * @Author: 谷花泰\n * @version: 1.0\n * @description: 让你可以直接下载保存喜欢的公众号音频，存着离线也能听。\n * @include: mp.weixin.qq.com\n * @createTime: 2019-10-04 01:47:08\n * @updateTime: 2019-10-08 17:24:27\n */\n  /* 判断是否该执行 */\n  (function () {\n  const whiteList = ['mp.weixin.qq.com'];\n  const hostname = window.location.hostname;\n  const key = encodeURIComponent('谷花泰:微信公众号音频下载:执行判断');\n\n  if (whiteList.indexOf(hostname) < 0 || window[key]) {\n    return;\n  };\n\n  window[key] = true;\n\n  /* 开始执行代码 */\n  class WxAudioDownload {\n    constructor() {\n      this._voiceIds = window.reportVoiceid;\n      this._qqMusicIds = Array.from(document.querySelectorAll('qqmusic[musictype=\"1\"]'), elm => {\n        return elm.getAttribute('otherid');\n      });\n      this._kugouMusicIds = Array.from(document.querySelectorAll('qqmusic[musictype=\"2\"]'), elm => {\n        return elm.getAttribute('otherid');\n      });\n      this.appendElement();\n    };\n    /* 普通音频 */\n    getVoiceInfo(voiceId) {\n      return new Promise((resolve, reject) => {\n        const voiceUrl = `https://res.wx.qq.com/voice/getvoice?mediaid=${voiceId}`;\n        const voiceTitle = document.querySelector(`#voice_title_${voiceId}_0`).innerText;\n        const voiceAuthorElement = document.querySelector(`#voice_author_${voiceId}_0`);\n        const voiceAuthor = voiceAuthorElement ? voiceAuthorElement.innerText : '';\n        const fileName = `${voiceTitle}--${voiceAuthor}.mp3`;\n        resolve({\n          url: voiceUrl,\n          fileName\n        });\n      });\n    };\n    /* QQ音乐 */\n    getQQMusicInfo(musicId) {\n      return new Promise((resolve, reject) => {\n        seajs.use(\"biz_wap/utils/ajax.js\", ajax => {\n          const api = `https://mp.weixin.qq.com/mp/qqmusic?action=get_song_info&song_mid=${musicId}`;\n          ajax({\n            url: api,\n            type: \"GET\",\n            dataType: \"json\",\n            success(res) {\n              if (200 == res.http_code) {\n                const musicData = JSON.parse(res.resp_data);\n                const musicName = musicData.songlist[0].song_name;\n                const musicAuthor = musicData.songlist[0].singer_name;\n                const fileName = `${musicName}--${musicAuthor}.mp3`;\n                const musicUrl = `${musicData.songlist[0].song_play_url}&__wxtag__=${musicId}`;\n                resolve({\n                  url: musicUrl,\n                  fileName\n                });\n              };\n            },\n            error(err) {\n              reject(err);\n            }\n          });\n        });\n      });\n    };\n    /* 酷狗音乐 */\n    getKugouMusicInfo(musicId) {\n      return new Promise((resolve, reject) => {\n        seajs.use(\"biz_wap/utils/ajax.js\", ajax => {\n          const params = [\n            {\n              akey: musicId,\n              albumid: \"\"\n            }\n          ];\n          const api = `https://mp.weixin.qq.com/mp/getkugousong?params=${encodeURIComponent(JSON.stringify(params))}`;\n          ajax({\n            url: api,\n            type: \"GET\",\n            dataType: \"json\",\n            success(res) {\n              const musicTag = document.querySelector(`qqmusic[otherid=\"${musicId}\"]`);\n              const musicName = musicTag.getAttribute('music_name');\n              const musicAuthor = musicTag.getAttribute('singer');\n              const fileName = `${musicName}--${musicAuthor}.mp3`;\n              const musicUrl = `${res.data[0].url}?&__wxtag__=${musicId}`;\n              resolve({\n                url: musicUrl,\n                fileName\n              });\n            },\n            error(err) {\n              reject(err);\n            }\n          })\n        });\n      });\n    };\n    /* 下载函数 */\n    downloadFile({ url, fileName }) {\n      let _fileName = fileName;\n      const a = document.createElement('a');\n      a.download = _fileName;\n      a.href = url;\n      a.style.display = \"none\";\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n    };\n    /* 把下载按钮添加到音乐后 */\n    appendElement() {\n      const mpvoiceElms = document.querySelectorAll('mpvoice');\n      const musicElms = document.querySelectorAll('qqmusic');\n\n      /* 普通音频 */\n      Array.from(mpvoiceElms, elm => {\n        const voiceId = elm.getAttribute('voice_encode_fileid');\n        const playerElm = elm.parentNode.querySelector('mpvoice+span');\n        const downloadElm = this.createDownloadElement(this.getVoiceInfo, voiceId);\n        this.insertAfter(downloadElm, playerElm);\n      });\n\n      /* QQ音乐与酷狗音乐 */\n      Array.from(musicElms, elm => {\n        const musicId = elm.getAttribute('otherid');\n        /* 1为QQ音乐，2为酷狗音乐 */\n        const type = Number(elm.getAttribute('musictype'));\n        const playerElm = elm.parentNode.querySelector('qqmusic+span');\n        /* 获取函数的名字 */\n        let getInfoName = 'getQQMusicInfo';\n        if (type === 1) {\n          getInfoName = 'getQQMusicInfo';\n        } else if (type === 2) {\n          getInfoName = 'getKugouMusicInfo';\n        };\n        const downloadElm = this.createDownloadElement(this[getInfoName], musicId);\n        this.insertAfter(downloadElm, playerElm);\n      });\n    };\n    /* 创建下载按钮 */\n    createDownloadElement(getDownloadInfo, audioId) {\n      const div = document.createElement('div');\n      div.setAttribute('style', `\n        width: 100% !important;\n        height: 40px;\n        text-align: center;\n        font-size: 16px;\n        line-height: 40px;\n        color: #333;\n        background-color: #fdfdfd;\n        border-radius: 2px;\n        font-weight: normal !important;\n        border: 1px solid #e2e2e2;\n      `);\n      div.innerText = '下载此音乐';\n      div.onclick = () => {\n        getDownloadInfo(audioId).then(res => {\n          const { url, fileName } = res;\n          if (!url) {\n            alert('恭喜，啥也没有');\n            return;\n          };\n          this.downloadFile({ url, fileName });\n        }).catch(err => console.log(err));\n      };\n      return div;\n    };\n    /*把节点插入到某节点后面*/\n    insertAfter(newElement, targetElement) {\n      const parentElement = targetElement.parentNode;\n      if (parentElement.lastChild == targetElement) {\n        parentElement.appendChild(newElement);\n      } else {\n        const next = targetElement.nextSibling;\n        parentElement.insertBefore(newElement, next);\n      };\n    };\n  };\n  /* 监听节点加载 */\n  const maxTime = 5000;\n  const timeInterval = 100;\n  let pastTime = 0;\n  const timerId = setInterval(() => {\n    pastTime += timeInterval;\n    if (pastTime < 1000) {\n      return;\n    };\n    const qqmusic = document.querySelector('qqmusic');\n    const mpvoice = document.querySelector('mpvoice');\n    if (qqmusic || mpvoice || maxTime < pastTime) {\n      new WxAudioDownload();\n      clearInterval(timerId);\n      return;\n    };\n  }, timeInterval);\n  })();","synopsis":"让你可以直接下载保存喜欢的公众号音频，存着离线也能听。","detail":"<p>搬运自 <a href=\"http://via-app.cn/#/pluginDetail/2\" rel=\"noopener noreferrer\">Via 轻插件</a> ，作者 <a href=\"http://via-app.cn/#/user/2\" rel=\"noopener noreferrer\">谷花泰</a></p><p><br></p><p>对原脚本进行如下修改 ：</p><ol><li>修复了有些音频没有作者，脚本报错的问题。</li></ol><p><br></p><p>以下是原版介绍 ：</p><p><br></p><h1>微信公众号音频下载教程</h1><p><br></p><h2><span style=\"background-color: rgb(250, 204, 204);\"> </span> 简介</h2><p><br></p><p>安装此插件后，复制微信文章链接在本浏览器打开，就可以看到音频下面有下载按钮。</p><p><br></p><h2><span style=\"background-color: rgb(250, 204, 204);\"> </span> 测试链接</h2><p><br></p><ol><li><a href=\"https://mp.weixin.qq.com/s/WEjsFfS6SiR97JQj7nry4g\" rel=\"noopener noreferrer\" style=\"background-color: transparent; color: rgb(240, 102, 102);\">音乐类型</a></li><li><a href=\"https://mp.weixin.qq.com/s/b2syiWkILKIQZg_-zhAJLg\" rel=\"noopener noreferrer\" style=\"background-color: transparent; color: rgb(240, 102, 102);\">录制的音频类型</a></li></ol><p><br></p><h2><span style=\"background-color: rgb(250, 204, 204);\"> </span> 使用</h2><p><br></p><ol><li>从公众号复制文章链接</li><li>粘贴链接到浏览器打开</li><li>点击音频下面的下载按钮</li><li>下载</li></ol><p><br></p><h2><span style=\"background-color: rgb(250, 204, 204);\"> </span> 补充问题</h2><p><br></p><p><strong style=\"color: rgb(240, 102, 102);\">我是安卓，下载不了</strong></p><p><br></p><p>有些手机不能在音乐下载链接唤起下载，请复制下载链接到系统浏览器或其他浏览器下载。</p><p><br></p><p><strong style=\"color: rgb(240, 102, 102);\">我是ios，下载不了</strong></p><p><br></p><p>请看这篇文章&nbsp;<a href=\"http://via-app.cn/#/ArticleDetail/5\" rel=\"noopener noreferrer\" style=\"background-color: transparent; color: rgb(240, 102, 102);\">alook浏览器下载资源教程</a></p><p><strong style=\"color: rgb(240, 102, 102);\">注意：频繁下载 QQ 音乐类型的音频可能会触发ip限制，导致一段时间内下载不了。</strong></p><p><br></p>","match":["mp.weixin.qq.com"]}